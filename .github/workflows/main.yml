name: Build and Release vCardEditor

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration'
        required: true
        default: 'Release'
        type: choice
        options:
          - Debug
          - Release
      tag:
        description: 'Version tag (e.g., 1.0.0 or v1.0.0)'
        required: false
        default: 'v1.0.0'
  
  # Trigger on release creation
  release:
    types: [published]

env:
  SOLUTION_NAME: 'vCardEditor.sln'
  PROJECT_NAME: 'vCardEditor'
  BUILD_CONFIGURATION: ${{ github.event.inputs.configuration || 'Release' }}

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    # Step 1: Checkout source code
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # Step 2: Normalize version tag
    - name: Normalize version tag
      id: normalize_version
      shell: bash
      run: |
        if [ "${{ github.event.release.tag_name }}" == "" ]; then
          version=$(echo ${{ github.event.inputs.tag || 'manual' }} | sed -e 's/v//g')
          echo "version=$version" >> "$GITHUB_OUTPUT"
        else
          version=$(echo ${{ github.event.release.tag_name }} | sed -e 's/v//g')
          echo "version=$version" >> "$GITHUB_OUTPUT"
        fi
    
    # Step 3: Setup MSBuild
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    # Step 4: Build the solution (continue even if test project fails)
    - name: Build vCardEditor
      run: |
        # Build the solution, continue on error for test projects
        msbuild ${{ env.SOLUTION_NAME }} `
          /p:Configuration=${{ env.BUILD_CONFIGURATION }} `
          /t:Rebuild `
          /m `
          /verbosity:minimal `
          /p:BuildInParallel=true `
          /p:ContinueOnError=WarnAndContinue
      continue-on-error: true
    
    # Step 5: Verify main project was built successfully
    - name: Verify and find built executable
      id: find_output
      run: |
        Write-Host "Searching for build output..."
        $exePath = Get-ChildItem -Path "${{ github.workspace }}" -Recurse -Filter "vCardEditor.exe" | 
                   Where-Object { $_.FullName -notmatch "\\obj\\" -and $_.FullName -match "\\bin\\${{ env.BUILD_CONFIGURATION }}" } | 
                   Select-Object -First 1
        
        if ($exePath) {
          $outputDir = $exePath.DirectoryName
          Write-Host "Found executable at: $outputDir"
          echo "OUTPUT_DIR=$outputDir" >> $env:GITHUB_OUTPUT
        } else {
          Write-Error "Executable not found!"
          exit 1
        }
    
    # Step 6: Create ZIP package with version
    - name: Create vCardEditor release ZIP
      run: |
        $outputPath = "${{ steps.find_output.outputs.OUTPUT_DIR }}"
        $version = "${{ steps.normalize_version.outputs.version }}"
        $zipName = "vCardEditor_Portable_${version}_windows_x64.zip"
        $zipPath = Join-Path "${{ github.workspace }}" $zipName
        
        Write-Host "Source directory: $outputPath"
        Write-Host "Version: $version"
        
        # Get only the exe file (exclude pdb and config)
        $exeFile = Get-ChildItem -Path $outputPath -Filter "*.exe" | Select-Object -First 1
        
        if ($exeFile) {
          Write-Host "Including: $($exeFile.Name)"
          
          # Create ZIP with the exe file
          Compress-Archive -Path $exeFile.FullName -DestinationPath $zipPath -Force
          
          Write-Host "Archive created: $zipPath"
          Write-Host "Size: $((Get-Item $zipPath).Length / 1MB) MB"
          
          # Save paths for later steps (use forward slashes for cross-platform compatibility)
          $relativePath = "./$zipName"
          echo "ZIP_NAME=$zipName" >> $env:GITHUB_OUTPUT
          echo "EXE_PATH=$($exeFile.FullName)" >> $env:GITHUB_OUTPUT
        } else {
          Write-Error "Executable not found!"
          exit 1
        }
      id: create_zip
    
    # Step 7: Upload artifact (for workflow_dispatch) - upload raw exe to avoid double-zip
    - name: Upload artifact
      if: github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: vCardEditor_Portable_${{ steps.normalize_version.outputs.version }}_windows_x64
        path: ${{ steps.create_zip.outputs.EXE_PATH }}
        retention-days: 30
    
    # Step 8: Upload to Release (for release event)
    - name: Upload to Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.normalize_version.outputs.version }}
        files: ${{ steps.create_zip.outputs.ZIP_NAME }}
        token: ${{ secrets.GITHUB_TOKEN }}
