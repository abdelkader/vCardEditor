name: Build and Release vCardEditor

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration'
        required: true
        default: 'Release'
        type: choice
        options:
          - Debug
          - Release
  
  # Trigger on release creation
  release:
    types: [created, published]

env:
  SOLUTION_NAME: 'vCardEditor.sln'
  PROJECT_NAME: 'vCardEditor'
  BUILD_CONFIGURATION: ${{ github.event.inputs.configuration || 'Release' }}

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    # Step 1: Checkout source code
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # Step 2: Setup MSBuild
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    # Step 3: Build the solution (continue even if test project fails)
    - name: Build vCardEditor
      run: |
        # Build the solution, continue on error for test projects
        msbuild ${{ env.SOLUTION_NAME }} `
          /p:Configuration=${{ env.BUILD_CONFIGURATION }} `
          /t:Rebuild `
          /m `
          /verbosity:minimal `
          /p:BuildInParallel=true `
          /p:ContinueOnError=WarnAndContinue
      continue-on-error: true
    
    # Step 4: Verify main project was built successfully
    - name: Verify and find built executable
      id: find_output
      run: |
        Write-Host "Searching for build output..."
        $exePath = Get-ChildItem -Path "${{ github.workspace }}" -Recurse -Filter "vCardEditor.exe" | 
                   Where-Object { $_.FullName -notmatch "\\obj\\" -and $_.FullName -match "\\bin\\${{ env.BUILD_CONFIGURATION }}" } | 
                   Select-Object -First 1
        
        if ($exePath) {
          $outputDir = $exePath.DirectoryName
          Write-Host "Found executable at: $outputDir"
          echo "OUTPUT_DIR=$outputDir" >> $env:GITHUB_OUTPUT
        } else {
          Write-Error "Executable not found!"
          exit 1
        }
    
    # Step 5: Create ZIP package
    - name: Create vCardEditor.release.zip
      run: |
        $outputPath = "${{ steps.find_output.outputs.OUTPUT_DIR }}"
        $zipPath = "${{ github.workspace }}\vCardEditor.release.zip"
        
        Write-Host "Creating archive from: $outputPath"
        
        # Compress all necessary files
        Compress-Archive -Path "$outputPath\*" -DestinationPath $zipPath -Force
        
        Write-Host "Archive created: $zipPath"
        Write-Host "Size: $((Get-Item $zipPath).Length / 1MB) MB"
    
    # Step 6: Upload artifact (for workflow_dispatch)
    - name: Upload artifact
      if: github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: vCardEditor-${{ env.BUILD_CONFIGURATION }}
        path: vCardEditor.release.zip
        retention-days: 30
    
    # Step 7: Upload to Release (for release event)
    - name: Upload to Release
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./vCardEditor.release.zip
        asset_name: vCardEditor.release.zip
        asset_content_type: application/zip
